---
import BaseLayout from '../layouts/BaseLayout.astro';

const title = 'Carrito - Tienda Kilo Cero';
---

<BaseLayout title={title}>
	<section class="">
		<div class="space-y-16">
			<div class="text-center space-y-4">
				<h1 class="text-4xl md:text-5xl font-title font-light text-header-text tracking-tight">
					Tu Carrito
				</h1>
				<p class="text-xl font-light text-header-text/70 max-w-2xl mx-auto leading-relaxed">
					Revisa tus productos seleccionados antes de proceder al pago
				</p>
			</div>

			<div id="cart-items" class="space-y-8">
				<!-- Los items del carrito se cargar√°n din√°micamente -->
			</div>

			<div id="cart-total" class="border-t border-header-text/10 pt-8">
				<div class="flex justify-between items-center">
					<span class="text-2xl font-light text-header-text tracking-wide">Total</span>
					<span class="text-3xl font-light text-primary">$<span id="total-amount">0</span></span>
				</div>
			</div>

			<div class="flex flex-col sm:flex-row gap-6 justify-center pt-8">
				<a href="/productos" class="bg-secondary text-secondary-text px-8 py-4 font-light tracking-wider hover:bg-primary hover:text-primary-text transition-all duration-500 ease-out text-center">
					Continuar Comprando
				</a>
				<a href="/checkout" id="checkout-btn" class="bg-primary text-primary-text px-8 py-4 font-light tracking-wider hover:bg-secondary transition-all duration-500 ease-out text-center">
					Proceder al Pago
				</a>
			</div>
		</div>
	</section>

	<script>
		import { CartService } from '../lib/cartService';

		// Extender la interfaz Window para TypeScript
		declare global {
			interface Window {
				showToast?: {
					success: (message: string, duration?: number) => string;
					error: (message: string, duration?: number) => string;
					warning: (message: string, duration?: number) => string;
					info: (message: string, duration?: number) => string;
				};
			}
		}

		let renderAttempts = 0;
		const MAX_ATTEMPTS = 5;

		function renderCart() {
			renderAttempts++;
			const cartItems = document.getElementById('cart-items');
			const totalAmount = document.getElementById('total-amount');
			const checkoutBtn = document.getElementById('checkout-btn');

			// Verificar si estamos en la p√°gina correcta
			if (!window.location.pathname.includes('/carrito')) {
				console.log('üè† No estamos en /carrito, cancelando render');
				return;
			}

			if (!cartItems || !totalAmount || !checkoutBtn) {
				if (renderAttempts < MAX_ATTEMPTS) {
					console.log(`‚è≥ DOM no listo (intento ${renderAttempts}/${MAX_ATTEMPTS}), esperando...`);
					console.log('Elementos encontrados:', {
						cartItems: !!cartItems,
						totalAmount: !!totalAmount,
						checkoutBtn: !!checkoutBtn
					});
					// Reintentar en 100ms si el DOM no est√° listo
					setTimeout(() => renderCart(), 100);
				} else {
					console.error('‚ùå No se pudo renderizar el carrito despu√©s de', MAX_ATTEMPTS, 'intentos');
					console.log('Estado final del DOM:', {
						cartItems: !!document.getElementById('cart-items'),
						totalAmount: !!document.getElementById('total-amount'),
						checkoutBtn: !!document.getElementById('checkout-btn'),
						currentPath: window.location.pathname
					});
				}
				return;
			}

			// Reset counter on successful render
			renderAttempts = 0;

			const cart = CartService.getCart();
			const total = CartService.getTotal();

			console.log(`üõí Carrito: ${cart.length} productos, Total: $${total}`);

			if (cart.length === 0) {
				cartItems.innerHTML = '<div class="text-center py-16"><p class="text-xl font-light text-header-text/70">Tu carrito est√° vac√≠o</p><p class="text-header-text/50 mt-4">Agrega algunos productos para continuar</p></div>';
				checkoutBtn.style.display = 'none';
			} else {
				checkoutBtn.style.display = 'inline-block';
				cartItems.innerHTML = cart.map(item => `
					<div class="flex items-center space-x-8 py-8 border-b border-header-text/10 last:border-b-0" data-product-id="${item.id}">
						<div class="w-20 h-20 overflow-hidden">
							<picture>
								<source srcset="${item.imagen.replace('.svg', '.webp')}" type="image/webp" />
								<img
									src="${item.imagen}"
									alt="${item.nombre}"
									width="80"
									height="80"
									loading="lazy"
									decoding="async"
									class="w-full h-full object-cover"
									style="background-color: rgba(229, 230, 228, 0.7);"
								/>
							</picture>
						</div>
						<div class="flex-1 space-y-2">
							<h3 class="font-light text-header-text tracking-wide">${item.nombre}</h3>
							<p class="text-header-text/60 text-sm">$${item.precio} cada uno</p>
						</div>
						<div class="flex items-center space-x-4">
							<div class="flex items-center space-x-3">
								<button class="w-8 h-8 flex items-center justify-center text-header-text hover:text-primary hover:bg-primary/10 transition-all duration-300 rounded" data-product-id="${item.id}">-</button>
								<span class="w-8 text-center text-header-text font-light">${item.cantidad}</span>
								<button class="w-8 h-8 flex items-center justify-center text-header-text hover:text-primary hover:bg-primary/10 transition-all duration-300 rounded" data-product-id="${item.id}">+</button>
							</div>
							<div class="text-right space-y-2">
								<p class="text-primary font-light text-lg">$${(item.precio * item.cantidad).toFixed(2)}</p>
								<button class="text-header-text/60 hover:text-primary transition-colors duration-300 text-sm" data-product-id="${item.id}">Eliminar</button>
							</div>
						</div>
					</div>
				`).join('');
			}

			totalAmount.textContent = total.toFixed(2);

			// Verificaci√≥n visual
			console.log('‚úÖ HTML insertado en cartItems:', cartItems.innerHTML.substring(0, 100) + '...');
			console.log('‚úÖ Total mostrado:', totalAmount.textContent);
			console.log('üéØ Renderizado completado exitosamente');
		}

		// Event listeners para botones
		document.addEventListener('click', (e) => {
			const target = e.target as HTMLElement;
			const productIdStr = target.dataset.productId;
			if (!productIdStr) return;
			const productId = parseInt(productIdStr);

			if (target.textContent === '+') {
				const cart = CartService.getCart();
				const item = cart.find(i => i.id === productId);
				if (item) {
					CartService.updateQuantity(productId, item.cantidad + 1);
					if (window.showToast) {
						window.showToast.info(`Cantidad aumentada: ${item.nombre}`);
					}
				}
			} else if (target.textContent === '-') {
				const cart = CartService.getCart();
				const item = cart.find(i => i.id === productId);
				if (item) {
					if (item.cantidad > 1) {
						CartService.updateQuantity(productId, item.cantidad - 1);
						if (window.showToast) {
							window.showToast.info(`Cantidad reducida: ${item.nombre}`);
						}
					} else {
						// Si es el √∫ltimo, preguntar antes de eliminar
						if (confirm(`¬øEliminar "${item.nombre}" del carrito?`)) {
							CartService.removeFromCart(productId);
							if (window.showToast) {
								window.showToast.warning(`"${item.nombre}" eliminado del carrito`);
							}
						}
					}
				}
			} else if (target.textContent === 'Eliminar') {
				const cart = CartService.getCart();
				const item = cart.find(i => i.id === productId);
				if (item && confirm(`¬øEliminar "${item.nombre}" del carrito?`)) {
					CartService.removeFromCart(productId);
					if (window.showToast) {
						window.showToast.warning(`"${item.nombre}" eliminado del carrito`);
					}
				}
			}
		});

		// Renderizar carrito cuando el DOM est√© listo
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', () => {
				setTimeout(() => renderCart(), 100);
			});
		} else {
			setTimeout(() => renderCart(), 100);
		}

		// Escuchar cambios en el carrito solo si estamos en la p√°gina correcta
		window.addEventListener('cartUpdated', () => {
			if (window.location.pathname.includes('/carrito')) {
				setTimeout(() => renderCart(), 50);
			}
		});
	</script>
</BaseLayout>