---
import BaseLayout from '../layouts/BaseLayout.astro';

const title = 'Carrito - Tienda Kilo Cero';
---

<BaseLayout title={title}>
	<section class="">
		<div class="space-y-16">
			<div class="text-center space-y-4">
				<h1 class="text-4xl md:text-5xl font-title font-light text-header-text tracking-tight">
					Tu Carrito
				</h1>
				<p class="text-xl font-light text-header-text/70 max-w-2xl mx-auto leading-relaxed">
					Revisa tus productos seleccionados antes de proceder al pago
				</p>
			</div>

			<div id="cart-items" class="space-y-8">
				<!-- Los items del carrito se cargarán dinámicamente -->
			</div>

			<div id="cart-total" class="border-t border-header-text/10 pt-8">
				<div class="flex justify-between items-center">
					<span class="text-2xl font-light text-header-text tracking-wide">Total</span>
					<span class="text-3xl font-light text-primary">$<span id="total-amount">0</span></span>
				</div>
			</div>

			<div class="flex flex-col sm:flex-row gap-6 justify-center pt-8">
				<a href="/productos" class="bg-secondary text-secondary-text px-8 py-4 font-light tracking-wider hover:bg-primary hover:text-primary-text transition-all duration-500 ease-out text-center">
					Continuar Comprando
				</a>
				<a href="/checkout" id="checkout-btn" class="bg-primary text-primary-text px-8 py-4 font-light tracking-wider hover:bg-secondary transition-all duration-500 ease-out text-center">
					Proceder al Pago
				</a>
			</div>
		</div>
	</section>

	<script>
		import { CartService } from '../lib/cartService';

		function renderCart() {
			const cartItems = document.getElementById('cart-items');
			const totalAmount = document.getElementById('total-amount');
			const checkoutBtn = document.getElementById('checkout-btn');

			if (!cartItems || !totalAmount || !checkoutBtn) return;

			const cart = CartService.getCart();
			const total = CartService.getTotal();

			if (cart.length === 0) {
				cartItems.innerHTML = '<div class="text-center py-16"><p class="text-xl font-light text-header-text/70">Tu carrito está vacío</p><p class="text-header-text/50 mt-4">Agrega algunos productos para continuar</p></div>';
				checkoutBtn.style.display = 'none';
			} else {
				checkoutBtn.style.display = 'inline-block';
				cartItems.innerHTML = cart.map(item => `
					<div class="flex items-center space-x-8 py-8 border-b border-header-text/10 last:border-b-0" data-product-id="${item.id}">
						<div class="w-20 h-20 overflow-hidden">
							<img src="${item.imagen}" alt="${item.nombre}" class="w-full h-full object-cover" style="background-color: rgba(229, 230, 228, 0.7);" />
						</div>
						<div class="flex-1 space-y-2">
							<h3 class="font-light text-header-text tracking-wide">${item.nombre}</h3>
							<p class="text-header-text/60 text-sm">$${item.precio} cada uno</p>
						</div>
						<div class="flex items-center space-x-4">
							<div class="flex items-center space-x-3">
								<button class="w-8 h-8 flex items-center justify-center text-header-text hover:text-primary hover:bg-primary/10 transition-all duration-300 rounded" data-product-id="${item.id}">-</button>
								<span class="w-8 text-center text-header-text font-light">${item.cantidad}</span>
								<button class="w-8 h-8 flex items-center justify-center text-header-text hover:text-primary hover:bg-primary/10 transition-all duration-300 rounded" data-product-id="${item.id}">+</button>
							</div>
							<div class="text-right space-y-2">
								<p class="text-primary font-light text-lg">$${(item.precio * item.cantidad).toFixed(2)}</p>
								<button class="text-header-text/60 hover:text-primary transition-colors duration-300 text-sm" data-product-id="${item.id}">Eliminar</button>
							</div>
						</div>
					</div>
				`).join('');
			}

			totalAmount.textContent = total.toFixed(2);
		}

		document.addEventListener('DOMContentLoaded', () => {
			renderCart();

			// Event listeners para botones
			document.addEventListener('click', (e) => {
				const target = e.target as HTMLElement;
				const productIdStr = target.dataset.productId;
				if (!productIdStr) return;
				const productId = parseInt(productIdStr);

				if (target.textContent === '+') {
					const cart = CartService.getCart();
					const item = cart.find(i => i.id === productId);
					if (item) CartService.updateQuantity(productId, item.cantidad + 1);
				} else if (target.textContent === '-') {
					const cart = CartService.getCart();
					const item = cart.find(i => i.id === productId);
					if (item) CartService.updateQuantity(productId, item.cantidad - 1);
				} else if (target.textContent === 'Eliminar') {
					CartService.removeFromCart(productId);
				}

				renderCart();
			});
		});

		// Escuchar cambios en el carrito
		window.addEventListener('cartUpdated', renderCart);
	</script>
</BaseLayout>